<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Grammar of Graphics</title>
    <meta charset="utf-8" />
    <meta name="author" content="Marcell Granát" />
    <meta name="date" content="2022-01-01" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/default-fonts.css" rel="stylesheet" />
    <link href="libs/panelset/panelset.css" rel="stylesheet" />
    <script src="libs/panelset/panelset.js"></script>
    <link href="libs/tile-view/tile-view.css" rel="stylesheet" />
    <script src="libs/tile-view/tile-view.js"></script>
  </head>
  <body>
    <textarea id="source">
class: center, middle, title-slide

.title[
# Grammar of Graphics
]
.subtitle[
## <img src="mnb_intezet.png" style="width:30.0%" />
Big Data and Data Visualisation
]
.author[
### Marcell Granát
]
.institute[
### Central Bank of Hungary &amp; .blue[John von Neumann University]
]
.date[
### 2022
]

---


&lt;style type="text/css"&gt;
.red { color: red; }
.blue { color: #378C95; }
strong { color: red; }
a { color: #378C95; font-weight: bold; }
.remark-inline-code { font-weight: 900; background-color: #a7d5e7; }
.caption { color: #378C95; font-style: italic; text-align: center; }

.content-box { 
box-sizing: content-box;
background-color: #378C95;
/* Total width: 160px + (2 * 20px) + (2 * 8px) = 216px
Total height: 80px + (2 * 20px) + (2 * 8px) = 136px
Content box width: 160px
Content box height: 80px */
}

.content-box-green {
background-color: #d9edc2;
}

.content-box-red {
background-color: #f9dbdb;
}

.fullprice {
text-decoration: line-through;
}
&lt;/style&gt;





# Today's .blue[Agenda]

---

#  Download the companies of S&amp;P 500

--

## What is in S&amp;P 500?

(https://www.slickcharts.com/sp500)[https://www.slickcharts.com/sp500]

--


```r
library(rvest)

tickers &lt;- read_html("https://www.slickcharts.com/sp500") %&gt;% 
  html_table() %&gt;% 
  .[[1]] %&gt;% 
  pull(Symbol)

tickers
```

```
##   [1] "AAPL"  "MSFT"  "AMZN"  "GOOGL" "BRK.B" "TSLA"  "GOOG"  "UNH"   "XOM"  
##  [10] "JNJ"   "NVDA"  "JPM"   "PG"    "CVX"   "V"     "HD"    "MA"    "LLY"  
##  [19] "BAC"   "PFE"   "ABBV"  "META"  "MRK"   "PEP"   "KO"    "COST"  "TMO"  
##  [28] "AVGO"  "WMT"   "MCD"   "CSCO"  "ACN"   "ABT"   "WFC"   "DHR"   "DIS"  
##  [37] "COP"   "LIN"   "TXN"   "NEE"   "BMY"   "VZ"    "ADBE"  "CRM"   "AMGN" 
##  [46] "CMCSA" "PM"    "HON"   "RTX"   "QCOM"  "UNP"   "T"     "NKE"   "LOW"  
##  [55] "GS"    "UPS"   "IBM"   "NFLX"  "CVS"   "INTC"  "CAT"   "MS"    "SPGI" 
##  [64] "SCHW"  "ORCL"  "ELV"   "AMD"   "BLK"   "INTU"  "DE"    "SBUX"  "MDT"  
##  [73] "LMT"   "PLD"   "PYPL"  "AMT"   "ADP"   "GILD"  "BA"    "C"     "AMAT" 
##  [82] "ISRG"  "GE"    "AXP"   "CI"    "MDLZ"  "TMUS"  "TJX"   "EOG"   "CB"   
##  [91] "ADI"   "MMC"   "NOW"   "TGT"   "BKNG"  "MO"    "REGN"  "VRTX"  "SLB"  
## [100] "SYK"   "PGR"   "MMM"   "DUK"   "NOC"   "ZTS"   "SO"    "MU"    "LRCX" 
## [109] "CSX"   "PNC"   "HUM"   "BDX"   "ETN"   "FISV"  "ITW"   "APD"   "TFC"  
## [118] "CL"    "CME"   "AON"   "PXD"   "USB"   "CCI"   "BSX"   "MPC"   "EQIX" 
## [127] "GM"    "WM"    "NSC"   "ICE"   "MRNA"  "F"     "EMR"   "DG"    "SHW"  
## [136] "OXY"   "GD"    "FCX"   "KLAC"  "PSX"   "ATVI"  "VLO"   "EL"    "ADM"  
## [145] "ORLY"  "D"     "MCK"   "SNPS"  "MET"   "ADSK"  "MCO"   "SRE"   "HCA"  
## [154] "DVN"   "APH"   "CNC"   "AZO"   "PSA"   "CTVA"  "EW"    "ROP"   "AEP"  
## [163] "GIS"   "AIG"   "CDNS"  "JCI"   "DXCM"  "MAR"   "COF"   "NXPI"  "A"    
## [172] "CHTR"  "TRV"   "SYY"   "KMB"   "LHX"   "IQV"   "BIIB"  "CMG"   "MCHP" 
## [181] "FDX"   "MSI"   "WMB"   "MSCI"  "PRU"   "TT"    "AFL"   "HES"   "O"    
## [190] "FIS"   "TEL"   "ENPH"  "PH"    "STZ"   "SPG"   "AJG"   "EXC"   "HLT"  
## [199] "PAYX"  "ECL"   "CTAS"  "DOW"   "MNST"  "ALB"   "ILMN"  "CARR"  "KMI"  
## [208] "NEM"   "IDXX"  "FTNT"  "XEL"   "NUE"   "AMP"   "ALL"   "DD"    "PCAR" 
## [217] "YUM"   "CMI"   "DLTR"  "EA"    "HAL"   "ROST"  "WELL"  "CSGP"  "MTD"  
## [226] "BK"    "ON"    "OTIS"  "RMD"   "TDG"   "HSY"   "SBAC"  "DLR"   "AME"  
## [235] "KDP"   "ANET"  "ROK"   "BKR"   "ED"    "KEYS"  "VICI"  "KR"    "PPG"  
## [244] "CTSH"  "TROW"  "APTV"  "CEG"   "DFS"   "FAST"  "KHC"   "STT"   "WBA"  
## [253] "FANG"  "MTB"   "PEG"   "WEC"   "GPN"   "ODFL"  "OKE"   "VRSK"  "HPQ"  
## [262] "BAX"   "ES"    "RSG"   "DHI"   "GWW"   "IT"    "AWK"   "GLW"   "CPRT" 
## [271] "WBD"   "WTW"   "EBAY"  "IFF"   "CBRE"  "GPC"   "FITB"  "CDW"   "WY"   
## [280] "URI"   "FTV"   "RJF"   "ZBH"   "HIG"   "ABC"   "FRC"   "VMC"   "PCG"  
## [289] "EFX"   "TSCO"  "AVB"   "LYB"   "CTRA"  "EIX"   "LH"    "NDAQ"  "LUV"  
## [298] "DAL"   "LEN"   "ETR"   "ULTA"  "MLM"   "ARE"   "MRO"   "IR"    "ANSS" 
## [307] "RF"    "PFG"   "DTE"   "HBAN"  "AEE"   "EQR"   "EXR"   "MKC"   "EPAM" 
## [316] "ACGL"  "FE"    "CAH"   "CF"    "PWR"   "CFG"   "PPL"   "DOV"   "XYL"  
## [325] "WAT"   "HPE"   "TSN"   "NTRS"  "SYF"   "TDY"   "HOLX"  "AES"   "INVH" 
## [334] "MOH"   "WST"   "WAB"   "KEY"   "EXPD"  "MAA"   "MOS"   "CNP"   "CHD"  
## [343] "PKI"   "VTR"   "VRSN"  "BALL"  "DGX"   "CINF"  "AMCR"  "MPWR"  "K"    
## [352] "IEX"   "DRI"   "CLX"   "STE"   "CMS"   "ABMD"  "CAG"   "TRGP"  "NTAP" 
## [361] "PAYC"  "J"     "BR"    "TTWO"  "SEDG"  "ALGN"  "APA"   "OMC"   "COO"  
## [370] "FMC"   "FDS"   "EQT"   "TRMB"  "SWKS"  "JBHT"  "EXPE"  "ATO"   "SJM"  
## [379] "IRM"   "TER"   "AVY"   "BBY"   "TXT"   "FLT"   "AKAM"  "ETSY"  "GRMN" 
## [388] "MTCH"  "INCY"  "UAL"   "WRB"   "LVS"   "LKQ"   "LDOS"  "POOL"  "NVR"  
## [397] "ESS"   "PTC"   "HWM"   "HRL"   "VTRS"  "SIVB"  "ZBRA"  "KIM"   "PEAK" 
## [406] "TECH"  "EVRG"  "LNT"   "IP"    "GEN"   "TYL"   "DPZ"   "BRO"   "HST"  
## [415] "RCL"   "NDSN"  "JKHY"  "IPG"   "BF.B"  "SNA"   "SWK"   "WDC"   "CRL"  
## [424] "CPT"   "PKG"   "RE"    "CHRW"  "CBOE"  "KMX"   "MGM"   "UDR"   "LW"   
## [433] "MAS"   "AAP"   "STX"   "CZR"   "CE"    "EMN"   "L"     "LYV"   "HSIC" 
## [442] "BXP"   "VFC"   "NRG"   "MKTX"  "NI"    "PHM"   "TFX"   "BWA"   "ALLE" 
## [451] "CCL"   "CDAY"  "QRVO"  "REG"   "GL"    "CPB"   "JNPR"  "TAP"   "CMA"  
## [460] "WRK"   "AAL"   "PARA"  "FOXA"  "BIO"   "ROL"   "HII"   "IVZ"   "SBNY" 
## [469] "FFIV"  "RHI"   "TPR"   "FBHS"  "WHR"   "CTLT"  "UHS"   "ZION"  "BBWI" 
## [478] "WYNN"  "HAS"   "PNW"   "AOS"   "PNR"   "SEE"   "FRT"   "BEN"   "NCLH" 
## [487] "GNRC"  "NWSA"  "XRAY"  "AIZ"   "DXC"   "OGN"   "ALK"   "LUMN"  "MHK"  
## [496] "LNC"   "NWL"   "RL"    "FOX"   "DISH"  "VNO"   "DVA"   "NWS"
```

---

#  Download the companies of S&amp;P 500

Let's use the `{tidyquant}` package to download the data.


```r
library(tidyquant)

getSymbols(tickers[1:6], from = '2021-11-14',
           to = "2022-11-14", warnings = FALSE,
           auto.assign = TRUE)
```

```
## Warning: BRK.B download failed; trying again.
```

```
## Warning: Unable to import "BRK.B".
## BRK.B download failed after two attempts. Error message:
## HTTP error 404.
```

```
## [1] "AAPL"  "MSFT"  "AMZN"  "GOOGL" "TSLA"
```

--

- This function creates a separate table for each of the stocks.

--

- We must put all tables into a single list to merge

---

#  Download the companies of S&amp;P 500

`ls` gives the name of the objects existing in the environment

`intersect` finds the values existing in both the environment and the tickers vector

--


```r
intersect(tickers, ls())
```

```
## [1] "AAPL"  "MSFT"  "AMZN"  "GOOGL" "TSLA"
```

---

#  Download the companies of S&amp;P 500

`get` helps you to refer to a given item from the environment by its name


```r
intersect(tickers, ls()) %&gt;% 
  tibble(tickers = .) %&gt;% 
  mutate(
    data = map(tickers, get)
  )
```

```
## # A tibble: 5 × 2
##   tickers data           
##   &lt;chr&gt;   &lt;list&gt;         
## 1 AAPL    &lt;xts [251 × 6]&gt;
## 2 MSFT    &lt;xts [251 × 6]&gt;
## 3 AMZN    &lt;xts [251 × 6]&gt;
## 4 GOOGL   &lt;xts [251 × 6]&gt;
## 5 TSLA    &lt;xts [251 × 6]&gt;
```

---

#  Download the companies of S&amp;P 500


```r
intersect(tickers, ls()) %&gt;% 
  tibble(tickers = .) %&gt;% 
  mutate(
    data = map(tickers, get)
  )
```

```
## # A tibble: 5 × 2
##   tickers data           
##   &lt;chr&gt;   &lt;list&gt;         
## 1 AAPL    &lt;xts [251 × 6]&gt;
## 2 MSFT    &lt;xts [251 × 6]&gt;
## 3 AMZN    &lt;xts [251 × 6]&gt;
## 4 GOOGL   &lt;xts [251 × 6]&gt;
## 5 TSLA    &lt;xts [251 × 6]&gt;
```

`xts` is a special format, where the time is name of the row. Let's convert it into a tidy data.frame (and some more cleaning)

---

#  Download the companies of S&amp;P 500


```r
intersect(tickers, ls()) %&gt;% 
  tibble(tickers = .) %&gt;% 
  mutate(
    data = map(tickers, get)
  ) %&gt;% 
  mutate(
    data = map(data, data.frame),
    data = map(data, function(x) rename_all(x, ~ gsub(".*[.]", "", .))),
    data = map(data, rownames_to_column, var = "time")
  ) %&gt;% 
  unnest(data) %&gt;% 
  mutate(time = as.Date(time))
```

```
## # A tibble: 1,255 × 8
##    tickers time        Open  High   Low Close    Volume Adjusted
##    &lt;chr&gt;   &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1 AAPL    2021-11-15  150.  152.  149.  150   59222800     149.
##  2 AAPL    2021-11-16  150.  151.  149.  151   59256200     150.
##  3 AAPL    2021-11-17  151   155   151.  153.  88807000     153.
##  4 AAPL    2021-11-18  154.  159.  153.  158. 137827700     157.
##  5 AAPL    2021-11-19  158.  161.  157.  161. 117305600     160.
##  6 AAPL    2021-11-22  162.  166.  161   161. 117467900     160.
##  7 AAPL    2021-11-23  161.  162.  159.  161.  96041900     160.
##  8 AAPL    2021-11-24  161.  162.  160.  162.  69463600     161.
##  9 AAPL    2021-11-26  160.  160.  156.  157.  76959800     156.
## 10 AAPL    2021-11-29  159.  161.  159.  160.  88748200     159.
## # … with 1,245 more rows
```







    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
